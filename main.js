"use strict";var p=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var S=(d,n)=>{for(var s in n)p(d,s,{get:n[s],enumerable:!0})},b=(d,n,s,i)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of y(n))!R.call(d,r)&&r!==s&&p(d,r,{get:()=>n[r],enumerable:!(i=w(n,r))||i.enumerable});return d};var F=d=>b(p({},"__esModule",{value:!0}),d);var C={};S(C,{default:()=>u});module.exports=F(C);var t=require("obsidian"),x={serverUrl:"http://localhost:8765",redactFolder:"redact/redacted",restoreFolder:"redact/reversed",mapsFolder:"redact/maps",deepScan:!1},P={PERSON:"names",COMPANY:"companies",PHONE:"phones",EMAIL:"emails",ADDRESS:"locations",POSTCODE:"postcodes",TAX:"tax IDs",NI:"NI numbers",DATE:"dates",URL:"URLs",CURRENCY:"amounts"};function T(d){return d.startsWith("http://localhost")||d.startsWith("http://127.0.0.1")}var u=class extends t.Plugin{constructor(){super(...arguments);this.serverOnline=!1}async onload(){if(t.Platform.isMobile){new t.Notice("Redactor is a desktop-only plugin.");return}await this.loadSettings();let s=this.addRibbonIcon("shield","Redactor: Redact current note",async()=>this.redactCurrentNote());s.addClass("redactor-ribbon");let i=this.addStatusBarItem();i.addClass("redactor-status-bar"),i.setText("\u{1F512} Redactor: checking\u2026"),i.onClickEvent(()=>{let r=this.app.setting;r&&(r.open(),r.openTabById("redactor-plugin"))}),this._ribbon=s,this._statusBar=i,this.addCommand({id:"redactor-redact-note",name:"Redact current note",callback:()=>void this.redactCurrentNote()}),this.addCommand({id:"redactor-restore-note",name:"Restore current note from map",callback:()=>void this.restoreCurrentNote()}),this.addCommand({id:"redactor-redact-selection",name:"Redact selected text",editorCallback:(r,e)=>void this.redactSelectedText(r,e)}),this.addCommand({id:"redactor-check-status",name:"Check Redactor server status",callback:()=>void this.checkServerStatus()}),this.registerEvent(this.app.workspace.on("file-menu",(r,e)=>{e instanceof t.TFile&&e.extension==="md"&&r.addItem(a=>{a.setTitle("Redact this note").setIcon("shield").onClick(()=>void this.redactFile(e))})})),this.addSettingTab(new g(this.app,this)),await this.updateServerStatus(),this.registerInterval(window.setInterval(()=>void this.updateServerStatus(),3e4))}async redactCurrentNote(){let s=this.app.workspace.getActiveFile();if(!s){new t.Notice("No active file.");return}await this.redactFile(s)}async redactFile(s){if(!this.assertOnline())return;let i;try{i=await this.app.vault.read(s)}catch(e){console.error("Redactor: failed to read file",e),new t.Notice(`Redactor: could not read ${s.name}`);return}let r;try{let e={text:i,deep_scan:this.settings.deepScan};r=(await(0,t.requestUrl)({url:`${this.settings.serverUrl}/redact`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json}catch(e){console.error("Redactor: /redact request failed",e),new t.Notice("Redactor: server offline \u2014 start run_phi.py first"),this.serverOnline=!1,this.refreshStatusUI();return}try{let e=`${this.settings.redactFolder}/${s.name}`,a=await this.saveVaultFile(e,r.redacted_text),o={file:s.name,created:new Date().toISOString(),tokens:r.map},l=`${this.settings.mapsFolder}/${s.name}.map.json`;await this.saveVaultFile(l,JSON.stringify(o,null,2));let c=this.buildCountSummary(r.entity_counts);new t.Notice(c),await this.app.workspace.getLeaf("tab").openFile(a)}catch(e){console.error("Redactor: failed to save redacted file",e),new t.Notice("Redactor: could not save output files.")}}async restoreCurrentNote(){if(!this.assertOnline())return;let s=this.app.workspace.getActiveFile();if(!s){new t.Notice("No active file.");return}let i=`${this.settings.mapsFolder}/${s.name}.map.json`,r=this.app.vault.getAbstractFileByPath(i);if(!(r instanceof t.TFile)){new t.Notice(`No map found for "${s.name}" \u2014 redact it first`);return}let e;try{let l=await this.app.vault.read(r);e=JSON.parse(l)}catch(l){console.error("Redactor: failed to read map file",l),new t.Notice("Redactor: map file is missing or corrupted.");return}let a;try{a=await this.app.vault.read(s)}catch(l){console.error("Redactor: failed to read file",l),new t.Notice(`Redactor: could not read ${s.name}`);return}let o;try{let l={text:a,map:e.tokens};o=(await(0,t.requestUrl)({url:`${this.settings.serverUrl}/restore`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})).json}catch(l){console.error("Redactor: /restore request failed",l),new t.Notice("Redactor: server offline \u2014 start run_phi.py first"),this.serverOnline=!1,this.refreshStatusUI();return}try{let l=`${this.settings.restoreFolder}/${s.name}`,c=await this.saveVaultFile(l,o.restored_text);new t.Notice(`Restored "${s.name}" successfully`),await this.app.workspace.getLeaf("tab").openFile(c)}catch(l){console.error("Redactor: failed to save restored file",l),new t.Notice("Redactor: could not save restored file.")}}async redactSelectedText(s,i){var l;if(!this.assertOnline())return;let r=s.getSelection();if(!r){new t.Notice("No text selected.");return}let e=i.file;if(!e){new t.Notice("No active file.");return}let a;try{let c={text:r,deep_scan:this.settings.deepScan};a=(await(0,t.requestUrl)({url:`${this.settings.serverUrl}/redact`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)})).json}catch(c){console.error("Redactor: /redact request failed",c),new t.Notice("Redactor: server offline \u2014 start run_phi.py first"),this.serverOnline=!1,this.refreshStatusUI();return}s.replaceSelection(a.redacted_text);try{let c=`${this.settings.mapsFolder}/${e.name}.map.json`,h=this.app.vault.getAbstractFileByPath(c),f={};if(h instanceof t.TFile)try{let v=await this.app.vault.read(h);f=(l=JSON.parse(v).tokens)!=null?l:{}}catch(v){}let m={file:e.name,created:new Date().toISOString(),tokens:{...f,...a.map}};await this.saveVaultFile(c,JSON.stringify(m,null,2))}catch(c){console.error("Redactor: failed to save map",c),new t.Notice("Redactor: selection redacted but map save failed.");return}let o=Object.values(a.entity_counts).reduce((c,h)=>c+h,0);new t.Notice(o===0?"No entities found in selection":`Redacted ${o} entities in selection`)}async checkServerStatus(){var s;try{let r=(await(0,t.requestUrl)({url:`${this.settings.serverUrl}/status`,method:"GET"})).json;new t.Notice(["Redactor server: online",`spaCy:  ${r.spacy?"\u2713 ready":"\u2717 not loaded"}`,`Phi-3:  ${r.phi3?`\u2713 ready (${(s=r.model)!=null?s:""})`:"\u2717 not loaded"}`].join(`
`),8e3)}catch(i){new t.Notice(`Redactor server: offline

Start run_phi.py to enable all features.`,6e3)}}async updateServerStatus(){try{await(0,t.requestUrl)({url:`${this.settings.serverUrl}/status`,method:"GET"}),this.serverOnline=!0}catch(s){this.serverOnline=!1}this.refreshStatusUI()}refreshStatusUI(){this.serverOnline?(this._statusBar.setText("\u{1F512} Redactor: online"),this._statusBar.removeClass("redactor-status-bar--offline"),this._statusBar.addClass("redactor-status-bar--online"),this._ribbon.style.color="var(--color-green)"):(this._statusBar.setText("\u{1F512} Redactor: offline"),this._statusBar.removeClass("redactor-status-bar--online"),this._statusBar.addClass("redactor-status-bar--offline"),this._ribbon.style.color="var(--color-red)")}async ensureFolder(s){if(!s)return;let i=s.split("/").filter(e=>e.length>0),r="";for(let e of i)if(r=r?`${r}/${e}`:e,!await this.app.vault.adapter.exists(r))try{await this.app.vault.createFolder(r)}catch(o){}}async saveVaultFile(s,i){let r=s.includes("/")?s.substring(0,s.lastIndexOf("/")):"";r&&await this.ensureFolder(r);let e=this.app.vault.getAbstractFileByPath(s);return e instanceof t.TFile?(await this.app.vault.modify(e,i),e):await this.app.vault.create(s,i)}assertOnline(){return this.serverOnline?!0:(new t.Notice("Redactor: server offline \u2014 start run_phi.py first"),!1)}buildCountSummary(s){var e;if(Object.values(s).reduce((a,o)=>a+o,0)===0)return"Redacted: no entities found";let r=[];for(let[a,o]of Object.entries(s))o>0&&r.push(`${o} ${(e=P[a])!=null?e:a.toLowerCase()}`);return`Redacted: ${r.join(", ")}`}async loadSettings(){this.settings=Object.assign({},x,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},g=class extends t.PluginSettingTab{constructor(n,s){super(n,s),this.plugin=s}display(){let{containerEl:n}=this;n.empty(),n.addClass("redactor-settings"),n.createEl("h2",{text:"Redactor"}),n.createEl("p",{text:"All redaction happens locally. The plugin connects only to the server URL below, which should be a local Python process you control.",cls:"redactor-settings__description"}),n.createEl("h3",{text:"Server"}),new t.Setting(n).setName("Server URL").setDesc("URL of the local run_phi.py server. Change this only if you've moved the server to a different port. Must start with http://localhost or http://127.0.0.1.").addText(e=>e.setPlaceholder("http://localhost:8765").setValue(this.plugin.settings.serverUrl).onChange(async a=>{let o=a.trim();T(o)||new t.Notice("\u26A0\uFE0F Warning: The server URL is not localhost. Your note content will be sent to that address. Make sure you trust and control that server.",1e4),this.plugin.settings.serverUrl=o,await this.plugin.saveSettings()})),new t.Setting(n).setName("Test connection").setDesc("Verify the server is reachable and check which models are loaded").addButton(e=>e.setButtonText("Test Connection").onClick(async()=>{e.setButtonText("Testing\u2026"),e.setDisabled(!0),await this.plugin.checkServerStatus(),await this.plugin.updateServerStatus(),e.setButtonText("Test Connection"),e.setDisabled(!1),this.display()}));let s=n.createDiv({cls:"redactor-settings__status-row"});s.createSpan().addClass(this.plugin.serverOnline?"redactor-dot-online":"redactor-dot-offline"),s.createSpan({text:` Server: ${this.plugin.serverOnline?"online":"offline"}`}),n.createEl("h3",{text:"Vault folders"}),new t.Setting(n).setName("Redacted notes folder").setDesc("Vault-relative path where redacted copies of your notes are saved. Created automatically if it does not exist.").addText(e=>e.setPlaceholder("redact/redacted").setValue(this.plugin.settings.redactFolder).onChange(async a=>{this.plugin.settings.redactFolder=a.trim(),await this.plugin.saveSettings()})),new t.Setting(n).setName("Restored notes folder").setDesc("Vault-relative path where restored notes (after LLM processing) are saved.").addText(e=>e.setPlaceholder("redact/reversed").setValue(this.plugin.settings.restoreFolder).onChange(async a=>{this.plugin.settings.restoreFolder=a.trim(),await this.plugin.saveSettings()})),new t.Setting(n).setName("Token maps folder").setDesc("Vault-relative path where token map files are stored. These files contain the original sensitive values \u2014 keep this folder private.").addText(e=>e.setPlaceholder("redact/maps").setValue(this.plugin.settings.mapsFolder).onChange(async a=>{this.plugin.settings.mapsFolder=a.trim(),await this.plugin.saveSettings()})),new t.Setting(n).setName("Open redacted folder in Finder").setDesc("Reveal the folder containing redacted files on disk").addButton(e=>e.setButtonText("Open in Finder").onClick(()=>{let a=this.app.vault.adapter;if(a instanceof t.FileSystemAdapter){let o=a.getFullPath(this.plugin.settings.redactFolder);require("electron").shell.openPath(o)}else new t.Notice("Cannot determine vault path on this platform.")})),n.createEl("h3",{text:"Detection"}),new t.Setting(n).setName("Deep Scan (Phi-3 Mini)").setDesc("When enabled, the local Phi-3 Mini language model also scans the text for additional PII beyond what regex and spaCy find. Slower but more thorough. Requires the Phi-3 model to be downloaded (~2 GB, cached automatically on first use).").addToggle(e=>e.setValue(this.plugin.settings.deepScan).onChange(async a=>{this.plugin.settings.deepScan=a,await this.plugin.saveSettings()})),n.createEl("h3",{text:"Privacy & network usage"});let r=n.createDiv({cls:"redactor-settings__disclosure"});r.createEl("p",{text:"This plugin does not connect to the internet. It connects only to the server URL above, which must be a local Python process (run_phi.py) running on your own machine."}),r.createEl("p",{text:"Your note content is sent to that local server for processing and is never transmitted beyond your device. Token maps containing the original sensitive values are stored inside your vault."})}};
